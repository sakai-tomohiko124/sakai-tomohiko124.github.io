<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>東京都の天気予報</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* --- 基本スタイルと背景 --- */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: 'Roboto Mono', 'Noto Sans JP', sans-serif;
            background: linear-gradient(135deg, #0f2027 0%, #2c5364 40%, #1a2980 70%, #00f2fe 100%);
            background-attachment: fixed;
            color: #f2f8ff;
            letter-spacing: 0.03em;
            position: relative;
            overflow-x: hidden;
        }
        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            z-index: -1;
            background: radial-gradient(circle at 80% 10%, #00f2fe55 0%, transparent 60%),
                        radial-gradient(circle at 20% 90%, #ae00ff44 0%, transparent 60%),
                        linear-gradient(120deg, #0f2027cc 0%, #2c5364cc 100%);
            filter: blur(8px) brightness(1.1);
            animation: bgmove 18s linear infinite alternate;
        }
        @keyframes bgmove {
            0% { filter: blur(8px) brightness(1.1); }
            100% { filter: blur(16px) brightness(1.2); }
        }
        
        /* --- ナビゲーション --- */
        .nav {
            background: rgba(20,30,60,0.8);
            backdrop-filter: blur(2px);
            color: #fff;
            padding: 0.7em 0;
            text-align: center;
            font-size: 1.1em;
            letter-spacing: 1px;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .nav a { color: #00e0ff; margin: 0 1em; text-decoration: underline; }

        /* --- コンテナ --- */
        .container {
            max-width: 900px;
            margin: 40px auto;
            background: rgba(20,30,60,0.92);
            padding: 24px 36px;
            border-radius: 18px;
            box-shadow: 0 0 32px #00f2fe44, 0 2px 24px #ae00ff22;
            backdrop-filter: blur(2px);
        }
        .header { text-align: center; border-bottom: 1px solid #00f2fe33; padding-bottom: 15px; margin-bottom: 20px; }
        h1 { margin: 0; color: #f2f8ff; text-shadow: 0 0 8px #00f2fe99; }
        .meta-info { font-size: 0.9em; color: #a0b0c0; margin-top: 10px; }
        
        /* --- 3日間予報 --- */
        .forecast-container { display: flex; justify-content: space-around; flex-wrap: wrap; gap: 20px; }
        .forecast-card {
            flex: 1;
            min-width: 250px;
            border: 1px solid #00f2fe33;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            background-color: rgba(0,242,254,0.08);
            transition: background-color 0.3s, box-shadow 0.3s;
        }
        .forecast-card.current-date { background-color: rgba(0,242,254,0.2); border-color: #00f2fe88; }
        .forecast-card h2 { margin: 0 0 15px 0; font-size: 1.4em; color: #00f2fe; text-shadow: 0 0 8px #00f2fe99; }
        .weather { font-weight: bold; font-size: 1.2em; margin-bottom: 15px; }
        .temps { font-size: 1.1em; margin-bottom: 15px; }
        .temp-max { color: #ff8a80; font-weight: bold; }
        .temp-min { color: #82b1ff; font-weight: bold; }
        .rain-chance-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px 10px; font-size: 0.9em; margin-top: 10px; }
        .rain-chance-grid div { text-align: center; }
        .rain-chance-label { color: #a0b0c0; padding: 2px 4px; border-radius: 4px; transition: background-color 0.3s, color 0.3s; }
        .rain-chance-label.current-hour-highlight { background-color: #e8f5e9; font-weight: bold; color: #2e7d32; }

        /* --- 1時間ごと予報 --- */
        .hourly-section { margin-top: 40px; }
        .hourly-section h3 { text-align: center; color: #00f2fe; text-shadow: 0 0 8px #00f2fe99; border-bottom: 1px solid #00f2fe33; padding-bottom: 10px; margin-bottom: 20px; }
        .hourly-forecast-container { display: flex; overflow-x: auto; padding: 10px 0 15px 0; border-radius: 8px; background: rgba(0,0,0,0.2); }
        .hourly-card { flex: 0 0 80px; padding: 10px; border-right: 1px solid #00f2fe22; text-align: center; font-size: 0.9em; transition: background-color 0.3s; }
        .hourly-card.current-hour-highlight { background-color: rgba(130, 177, 255, 0.2); }
        .hourly-card:last-child { border-right: none; }
        .hourly-time { font-weight: bold; }
        .hourly-weather { font-size: 0.85em; height: 3em; display: flex; align-items: center; justify-content: center; }
        .hourly-temp { font-size: 1.1em; font-weight: bold; margin: 5px 0; }
        .hourly-precip { font-size: 0.85em; color: #82b1ff; }
        .hourly-date-separator { flex: 0 0 100px; font-weight: bold; color: #00f2fe; display: flex; align-items: center; justify-content: center; border-right: 1px solid #00f2fe33; background-color: rgba(0, 242, 254, 0.1); }

        /* メッセージボックス */
        .message-box { text-align: center; color: #a0b0c0; padding: 30px; border: 1px dashed #00f2fe55; border-radius: 8px; background-color: transparent; }
        .message-box.error { color: #ff8a80; border-color: #ff8a80; }

        @media (max-width: 600px) {
            .container { padding: 6vw 2vw; border-radius: 0; margin: 0; }
            .nav a { margin: 0 0.5em; font-size: 0.9em; }
        }
    </style>
</head>
<body>
	<nav style="background:#222; color:#fff; padding:0.7em 0; text-align:center; font-size:1.1em; letter-spacing:1px;">
    <a href="home.html" style="color:#00e0ff; margin:0 1em; text-decoration:underline;">ホーム</a>
    <a href="index2.html" style="color:#00e0ff; margin:0 1em; text-decoration:underline;">クイズ</a>
    <a href="index5.html" style="color:#00e0ff; margin:0 1em; text-decoration:underline;">マニュアル</a>
    <a href="アンケート.html" style="font-weight: bold;" target="_blank">アンケート画面へ</a>
  </nav>

    <div class="container">
        <div class="header">
            <h1>東京都の天気予報</h1>
            <div class="meta-info">
                <span id="publishing-office"></span> 発表: <span id="report-time"></span>
            </div>
        </div>
        
        <div id="forecast-container" class="forecast-container">
            <div class="message-box" style="width: 100%;"><p>3日間予報を読み込んでいます...</p></div>
        </div>

        <div class="hourly-section">
            <h3>時間ごとの予報（72時間）</h3>
            <div id="hourly-forecast-container" class="hourly-forecast-container">
                <div class="message-box" style="width: 100%;"><p>1時間ごと予報を読み込んでいます...</p></div>
            </div>
        </div>
    </div>

    <script>
        const UPDATE_INTERVAL_MS = 30 * 60 * 1000;
        
        const forecastContainer = document.getElementById('forecast-container');
        const hourlyContainer = document.getElementById('hourly-forecast-container');
        const publishingOfficeElem = document.getElementById('publishing-office');
        const reportTimeElem = document.getElementById('report-time');

        function renderDailyForecast(forecasts) {
            forecastContainer.innerHTML = '';
            const now = new Date();
            const todayStr = now.toISOString().split('T')[0];
            const currentHour = now.getHours();

            forecasts.slice(0, 3).forEach((forecast, index) => {
                const card = document.createElement('div');
                card.className = 'forecast-card';
                if (forecast.date === todayStr) {
                    card.classList.add('current-date');
                }

                let dateLabel = new Date(forecast.date).toLocaleDateString('ja-JP', { month: 'numeric', day: 'numeric' });
                if (index === 0) dateLabel += " (今日)";
                if (index === 1) dateLabel += " (明日)";
                
                let rainGridHTML = '<div class="rain-chance-grid">';
                const timeSlots = [
                    { label: "0-6時", endHour: 6, value: forecast.chance_of_rain[0] },
                    { label: "6-12時", endHour: 12, value: forecast.chance_of_rain[1] },
                    { label: "12-18時", endHour: 18, value: forecast.chance_of_rain[2] },
                    { label: "18-24時", endHour: 24, value: forecast.chance_of_rain[3] }
                ];

                let currentSlotFound = false;
                timeSlots.forEach(slot => {
                    let labelClass = 'rain-chance-label';
                    
                    if (forecast.date === todayStr) {
                        if (currentHour >= slot.endHour) {
                            return;
                        }
                        if (!currentSlotFound && currentHour < slot.endHour) {
                            labelClass += ' current-hour-highlight';
                            currentSlotFound = true;
                        }
                    }
                    
                    rainGridHTML += `
                        <div class="${labelClass}">${slot.label}</div>
                        <div>${slot.value}%</div>
                    `;
                });
                rainGridHTML += '</div>';

                card.innerHTML = `
                    <h2>${dateLabel}</h2>
                    <div class="weather">${forecast.weather}</div>
                    <div class="temps">
                        <span class="temp-max">${forecast.temp_max}°C</span> / <span class="temp-min">${forecast.temp_min}°C</span>
                    </div>
                    <strong>降水確率</strong>
                    ${rainGridHTML}
                `;
                forecastContainer.appendChild(card);
            });
        }

        function renderHourlyForecast(hourlyForecasts) {
            hourlyContainer.innerHTML = '';
            const now = new Date();
            
            const upcomingHourly = hourlyForecasts.filter(hour => new Date(hour.iso_time) >= now);

            let lastDate = null;
            upcomingHourly.forEach((hour, index) => {
                const hourDateObj = new Date(hour.iso_time);
                const hourDateStr = hourDateObj.toLocaleDateString('ja-JP', { month: 'numeric', day: 'numeric' });

                if (hourDateStr !== lastDate) {
                    const dateSeparator = document.createElement('div');
                    dateSeparator.className = 'hourly-date-separator';
                    dateSeparator.textContent = hourDateStr;
                    hourlyContainer.appendChild(dateSeparator);
                    lastDate = hourDateStr;
                }

                const card = document.createElement('div');
                card.className = 'hourly-card';
                
                if (index === 0) {
                    card.classList.add('current-hour-highlight');
                }

                card.innerHTML = `
                    <div class="hourly-time">${hour.time}</div>
                    <div class="hourly-weather">${hour.weather}</div>
                    <div class="hourly-temp">${hour.temp}°C</div>
                    <div class="hourly-precip">${hour.precip}mm</div>
                `;
                hourlyContainer.appendChild(card);
            });
        }

        async function fetchAndUpdateWeather() {
            try {
                const response = await fetch('weather_info.json?t=' + new Date().getTime());
                if (!response.ok) throw new Error(`データ取得エラー (HTTP ${response.status})`);
                
                const data = await response.json();
                if (data.error) throw new Error(data.error);

                publishingOfficeElem.textContent = data.publishingOffice;
                reportTimeElem.textContent = new Date(data.reportDatetime).toLocaleString('ja-JP');
                
                renderDailyForecast(data.forecasts);
                renderHourlyForecast(data.hourly_forecast);

            } catch (error) {
                const errorMessage = `<div class="message-box error" style="width: 100%;"><p><strong>天気情報の取得に失敗しました。</strong></p><p><small>${error.message}</small></p></div>`;
                forecastContainer.innerHTML = errorMessage;
                hourlyContainer.innerHTML = errorMessage;
            }
        }

        fetchAndUpdateWeather();
        setInterval(fetchAndUpdateWeather, UPDATE_INTERVAL_MS);
    </script>
</body>
</html>