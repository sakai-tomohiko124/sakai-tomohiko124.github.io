
<!DOCTYPE html>
<html lang="ja">
<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>ãƒãƒ£ãƒƒãƒˆ</title>
		<script src="static/points.js"></script>
		<script src="static/points-header.js"></script>
		<link rel="stylesheet" href="static/responsive-header.css">
		<style>
			html, body {
				height: 100%;
				min-height: 100vh;
				margin: 0;
				padding: 0;
			}
			body {
				font-family: 'Roboto Mono', 'Noto Sans JP', sans-serif;
				background: linear-gradient(135deg, #0f2027 0%, #2c5364 40%, #1a2980 70%, #00f2fe 100%);
				background-attachment: fixed;
				min-height: 100vh;
				color: #f2f8ff;
				letter-spacing: 0.03em;
				position: relative;
				overflow-x: hidden;
			}
			body::before {
				content: '';
				position: fixed;
				top: 0; left: 0; width: 100vw; height: 100vh;
				z-index: -1;
				background: radial-gradient(circle at 80% 10%, #00f2fe55 0%, transparent 60%),
							radial-gradient(circle at 20% 90%, #ae00ff44 0%, transparent 60%),
							linear-gradient(120deg, #0f2027cc 0%, #2c5364cc 100%);
				filter: blur(8px) brightness(1.1);
				animation: bgmove 18s linear infinite alternate;
			}
			@keyframes bgmove {
				0% { filter: blur(8px) brightness(1.1); }
				100% { filter: blur(16px) brightness(1.2); }
			}
			.container {
				max-width: 700px;
				margin: 40px auto;
				background: rgba(20,30,60,0.92);
				padding: 36px 18px;
				border-radius: 18px;
				box-shadow: 0 0 32px #00f2fe44, 0 2px 24px #ae00ff22;
				backdrop-filter: blur(2px);
			}
			.hidden { display: none; }
			.chat-box {
				border: 1.5px solid #00f2fe88;
				height: 340px;
				overflow-y: auto;
				margin-bottom: 16px;
				padding: 14px;
				background: rgba(10,20,40,0.85);
				font-size: 1.12em;
				border-radius: 8px;
				box-shadow: 0 0 12px #00f2fe22;
				display: flex;
				flex-direction: column;
			}
			.msg { margin: 4px 0; }
			.msg.admin { color: #00f2fe; text-shadow: 0 0 6px #00f2fe99; align-self: flex-start; }
			.msg.user { color: #fff; text-shadow: 0 0 4px #ae00ff33; align-self: flex-end; }
			.input-row { display: flex; gap: 8px; }
			.input-row input[type="text"] { flex: 1; }
			.toggle-pw { cursor: pointer; font-size: 13px; color: #00f2fe; margin-left: 4px; text-shadow: 0 0 4px #00f2fe99; }
			.user-list { margin: 8px 0; }
			input, button, textarea, select {
				font-family: inherit;
				border-radius: 6px;
				border: 1px solid #00f2fe55;
				background: #181f2b;
				color: #f2f8ff;
				padding: 8px 10px;
				margin-bottom: 4px;
				outline: none;
				box-shadow: 0 0 6px #00f2fe22;
				transition: border 0.2s, box-shadow 0.2s;
			}
			input:focus, textarea:focus, select:focus {
				border: 1.5px solid #00f2fe;
				box-shadow: 0 0 12px #00f2fe55;
			}
			button {
				background: linear-gradient(90deg, #00f2fe 0%, #ae00ff 100%);
				color: #fff;
				border: none;
				font-weight: bold;
				cursor: pointer;
				box-shadow: 0 0 8px #00f2fe44;
				transition: background 0.2s, box-shadow 0.2s;
			}
			button:hover {
				background: linear-gradient(90deg, #ae00ff 0%, #00f2fe 100%);
				box-shadow: 0 0 16px #ae00ff66;
			}
			/* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
			@media (max-width: 900px) {
				.container { max-width: 98vw; }
			}
			@media (max-width: 600px) {
				.container { max-width: 100vw; margin: 0; padding: 6vw 2vw; border-radius: 0; }
				.chat-box { height: 38vw; min-height: 120px; font-size: 0.98em; }
				h2 { font-size: 1.2em; }
				input, button, textarea, select { font-size: 1em; }
				.input-row { flex-direction: column; gap: 6px; }
				.input-row input[type="text"] { width: 100%; }
				.toggle-pw { font-size: 11px; }
			}
			@media (max-width: 400px) {
				.container { padding: 2vw 1vw; }
				.chat-box { font-size: 0.92em; }
			}
		</style>
		
		<!-- ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ç”¨CSS -->
		<style>
			/* ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒœã‚¿ãƒ³ */
			#hamburger-menu-btn {
				display: none;
				position: fixed;
				top: 15px;
				left: 15px;
				z-index: 3000;
				background: linear-gradient(135deg, #00e0ff, #ae00ff);
				border: none;
				border-radius: 8px;
				padding: 12px 15px;
				font-size: 1.5em;
				color: #fff;
				cursor: pointer;
				transition: all 0.3s ease;
				box-shadow: 0 4px 15px rgba(0, 224, 255, 0.3);
			}
			#hamburger-menu-btn:hover {
				transform: translateY(-2px);
				box-shadow: 0 6px 20px rgba(174, 0, 255, 0.4);
			}

			/* PCç”¨ãƒˆãƒƒãƒ—ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
			.responsive-nav {
				background: #222; color: #fff; padding: 0.7em 0; text-align: center;
				font-size: 1.1em; letter-spacing: 1px; display: none;
			}
			.responsive-nav a {
				color: #00e0ff; margin: 0 1em; text-decoration: underline;
			}
			.responsive-nav a.highlight {
				font-weight: bold;
			}

			/* ã‚µã‚¤ãƒ‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ */
			#table-of-contents {
				width: 280px; background-color: #1a1a1a; color: #e0e0e0; padding: 20px;
				height: 100vh; position: fixed; top: 0; left: 0; overflow-y: auto;
				transition: transform 0.3s ease; z-index: 2000;
				border-right: 1px solid #00e0ff; transform: translateX(-100%);
			}
			#table-of-contents.open { transform: translateX(0); }
			#table-of-contents h2 {
				color: #00e0ff; font-family: 'Roboto Mono', monospace;
				margin-top: 0; font-size: 1.5em;
			}
			#table-of-contents ul { list-style: none; padding: 0; margin: 0; }
			#table-of-contents li a {
				display: block; color: #b0b0b0; text-decoration: none;
				padding: 10px 15px; border-radius: 5px; transition: all 0.2s;
				font-size: 0.95em;
			}
			#table-of-contents li a:hover {
				background-color: rgba(0, 224, 255, 0.1); color: #ffffff;
			}

			/* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–åˆ‡ã‚Šæ›¿ãˆ */
			@media (min-width: 769px) {
				.responsive-nav { display: block; }
			}

			@media (max-width: 768px) {
				#hamburger-menu-btn { display: block; }
				.responsive-nav { display: none; }
			}
		</style>
	</head>
	<body>
	<button id="hamburger-menu-btn">
		<span class="hamburger-line"></span>
	</button>
	
	<!-- PCç”¨ãƒˆãƒƒãƒ—ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
	<nav class="responsive-nav">
		<a href="home.html">ãƒ›ãƒ¼ãƒ </a>
		<a href="index2.html">ã‚¯ã‚¤ã‚º</a>
		<a href="index5.html">ãƒãƒ‹ãƒ¥ã‚¢ãƒ«</a>
		<a href="https://www.rakuten.co.jp/kbsanhe/">æ¥½å¤©ã‚µã‚¤ãƒˆ</a>
		<a href="ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆ.html" class="highlight" target="_blank">ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆç”»é¢ã¸</a>
	</nav>

	<!-- ã‚µã‚¤ãƒ‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
	<aside id="table-of-contents">
		<h2>å…¨ãƒªãƒ³ã‚¯é›†</h2>
		<ul>
			<li><a href="home.html">ğŸ  ãƒ›ãƒ¼ãƒ </a></li>
			<li><a href="index2.html">ğŸ§  ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã‚¯ã‚¤ã‚º</a></li>
			<li><a href="index5.html">ğŸ“– ãƒãƒ‹ãƒ¥ã‚¢ãƒ«</a></li>
			<li><a href="ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆ.html">ğŸ“Š ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆç”»é¢ã¸</a></li>
			<li><a href="logout.html">ğŸ”’ ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</a></li>
			<li><a href="link.html">ğŸ“‘ å…¨ãƒªãƒ³ã‚¯é›†</a></li>
			<li><a href="hate.html">ğŸ¯ è‹¦æ‰‹å…‹æœ</a></li>
			<li><a href="hate/base.html">ğŸ“š ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èªç”¨èªé›†</a></li>
			<li><a href="https://docs.python.org/ja/3/" target="_blank">ï¿½ Pythonå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ</a></li>
			<li><a href="https://www.w3schools.com/sql/" target="_blank">ğŸ—„ï¸ SQLãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«</a></li>
			<li><a href="pythonexam.html">ğŸ“ Pythonè©¦é¨“æƒ…å ±</a></li>
			<li><a href="æ„Ÿæƒ³.html">âœï¸ Pythonèªå®šåŸºç¤è©¦é¨“ã®æ„Ÿæƒ³</a></li>
			<li><a href="https://www.rakuten.co.jp/kbsanhe/" target="_blank">ğŸ›’ æ¥½å¤©ã‚µã‚¤ãƒˆ</a></li>
			<li><a href="weather.html">ğŸŒ¤ï¸ å¤©æ°—æƒ…å ±</a></li>
			<li><a href="train.html">ï¿½ é›»è»Šæƒ…å ±</a></li>
			<li><a href="other.html">ğŸ”— ãã®ä»–</a></li>
			<li><a href="index3.html">ï¿½ ãƒãƒ£ãƒƒãƒˆ</a></li>
			<li><a href="index4.html">ğŸ”— ä¾¿åˆ©ãƒªãƒ³ã‚¯</a></li>
			<li><a href="story.html">ğŸ“– ç‰©èª</a></li>

		</ul>
	</aside>

<div class="container">
	<!-- æ–°è¦ç™»éŒ²ç”»é¢ -->
	<div id="register-area">
		<h2>æ–°è¦ç™»éŒ²</h2>
		<input id="reg-username" type="text" placeholder="ãƒ¦ãƒ¼ã‚¶å"><br>
		<input id="reg-password" type="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
		<span class="toggle-pw" onclick="togglePw('reg-password', this)">è¡¨ç¤º</span><br>
		<button onclick="registerUser()">ç™»éŒ²</button>
		<p>æ—¢ã«ç™»éŒ²æ¸ˆã¿ï¼Ÿ <a href="#" onclick="showLogin()">ãƒ­ã‚°ã‚¤ãƒ³</a></p>
		<div id="reg-msg" style="color:red;"></div>
	</div>

	<!-- ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ -->
	<div id="login-area" class="hidden">
		<h2>ãƒ­ã‚°ã‚¤ãƒ³</h2>
		<input id="login-username" type="text" placeholder="ãƒ¦ãƒ¼ã‚¶å"><br>
		<input id="login-password" type="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
		<span class="toggle-pw" onclick="togglePw('login-password', this)">è¡¨ç¤º</span><br>
		<button onclick="loginUser()">ãƒ­ã‚°ã‚¤ãƒ³</button>
		<p>æœªç™»éŒ²ï¼Ÿ <a href="#" onclick="showRegister()">æ–°è¦ç™»éŒ²</a></p>
		<div id="login-msg" style="color:red;"></div>
	</div>

	<!-- ãƒãƒ£ãƒƒãƒˆç”»é¢ï¼ˆåˆ©ç”¨è€…ç”¨ï¼‰ -->
	<div id="chat-area" class="hidden">
		<h2>ãƒãƒ£ãƒƒãƒˆ</h2>
		<div class="chat-box" id="chat-box"></div>
		<div id="typing-indicator" style="display:none; color:#00f2fe; margin:4px 0;">ç®¡ç†è€… ãŒå…¥åŠ›ä¸­...</div>
		<div id="answer-options" style="margin:8px 0;"></div>
		<div class="input-row">
			<textarea id="chat-input" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›" rows="1" style="resize: none; overflow: hidden;" onkeydown="handleKeyDown(event)" oninput="autoResize(this); updateSuggestions(); showTyping(); clearTimeout(typingTimer); typingTimer = setTimeout(hideTyping, 1000);"></textarea>
			<button onclick="sendMessage()">é€ä¿¡</button>
		</div>
		<div id="suggestions" style="margin:8px 0; display:flex; gap:8px; flex-wrap:wrap;">
			<!-- ææ¡ˆè³ªå•ãƒœã‚¿ãƒ³ -->
		</div>
		<div style="margin:12px 0;">
			<label>è‡ªåˆ†ã®ãƒ¡ãƒ¢ï¼š</label><br>
			<textarea id="user-memo" rows="2" style="width:100%;"></textarea>
			<button onclick="saveUserMemo()">ãƒ¡ãƒ¢ä¿å­˜</button>
			<span id="memo-msg" style="color:green;"></span>
		</div>
		<div style="margin:12px 0;">
			<button onclick="resetChat()" style="background:#ff4d4d; color:#fff; border:none; padding:6px 12px; border-radius:4px;">ä¼šè©±å±¥æ­´ãƒªã‚»ãƒƒãƒˆ</button>
			<button onclick="exportChat('txt')" style="background:#00f2fe; color:#fff; border:none; padding:6px 12px; border-radius:4px;">å±¥æ­´ä¿å­˜ (TXT)</button>
			<button onclick="exportChat('csv')" style="background:#00f2fe; color:#fff; border:none; padding:6px 12px; border-radius:4px;">å±¥æ­´ä¿å­˜ (CSV)</button>
		</div>
		<div style="margin:28px 0 0 0; text-align:center;">
			<button onclick="window.open('https://tmhk-chat.ddns.net/', '_blank')" style="background:linear-gradient(90deg,#ff00cc 0%,#00f2fe 100%);color:#fff;font-size:1.25em;font-weight:bold;padding:18px 38px;border-radius:14px;border:none;box-shadow:0 0 18px #00f2fe88,0 2px 12px #ae00ff55;letter-spacing:2px;cursor:pointer;transition:background 0.2s,box-shadow 0.2s;">
				ãã†ã„ã†æ™‚ã¯AREã 
			</button>
		</div>
		<button onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
	</div>

	<!-- ç®¡ç†è€…ç”»é¢ -->
	<div id="admin-area" class="hidden">
		<h2>ç®¡ç†è€…ãƒãƒ£ãƒƒãƒˆ</h2>
		<div>
			<label>ãƒ¦ãƒ¼ã‚¶ãƒ¼é¸æŠï¼š</label>
			<select id="admin-user-list" onchange="showAdminChat();showAdminMemo();"></select>
		</div>
		<div class="chat-box" id="admin-chat-box"></div>
		<div class="input-row">
			<input id="admin-chat-input" type="text" placeholder="è¿”ä¿¡ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸">
			<button onclick="sendAdminMessage()">è¿”ä¿¡</button>
		</div>
		<div style="margin:16px 0;">
			<h3>ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§</h3>
			<ul id="admin-user-list-view" style="padding-left:1.2em;"></ul>
			<div style="margin:10px 0 0 0;">
				<input id="admin-add-username" type="text" placeholder="æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼å" style="width:40%;">
				<input id="admin-add-password" type="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" style="width:40%;">
				<button onclick="adminAddUser()">è¿½åŠ </button>
			</div>
			<div style="margin:8px 0;">
				<button onclick="adminDeleteUser()" style="background:#ff4d4d; color:#fff; border:none; padding:6px 16px; border-radius:4px;">é¸æŠãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤</button>
				<span id="admin-user-msg" style="color:#d00; margin-left:8px;"></span>
			</div>
			<h3>é¸æŠãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¡ãƒ¢</h3>
			<div id="admin-user-memo" style="background:#f8f8f8; border:1px solid #ccc; min-height:2em; padding:8px; border-radius:4px;"></div>
		</div>
				<div style="margin:28px 0 0 0; text-align:center;">
			<button onclick="window.open('https://tmhk-chat.ddns.net/', '_blank')" style="background:linear-gradient(90deg,#ff00cc 0%,#00f2fe 100%);color:#fff;font-size:1.25em;font-weight:bold;padding:18px 38px;border-radius:14px;border:none;box-shadow:0 0 18px #00f2fe88,0 2px 12px #ae00ff55;letter-spacing:2px;cursor:pointer;transition:background 0.2s,box-shadow 0.2s;">
				ãã†ã„ã†æ™‚ã¯AREã 
			</button>
		</div>
		<button onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
	</div>
</div>

<script>
// ========================================
// ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–: F12ç„¡åŠ¹åŒ–ãƒ»å³ã‚¯ãƒªãƒƒã‚¯ç„¡åŠ¹åŒ–
// ========================================
(function() {
	'use strict';
	
	// F12ã‚­ãƒ¼ã€é–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«ã€ã‚½ãƒ¼ã‚¹è¡¨ç¤ºç„¡åŠ¹åŒ–
	document.addEventListener('keydown', e => {
		if (e.key === 'F12' || 
			(e.ctrlKey && e.shiftKey && ['I', 'J', 'C'].includes(e.key.toUpperCase())) ||
			(e.metaKey && e.altKey && ['I', 'J', 'C'].includes(e.key.toUpperCase())) ||
			(e.ctrlKey && e.key.toLowerCase() === 'u') ||
			(e.metaKey && e.key.toLowerCase() === 'u')) {
			e.preventDefault();
			alert('âš ï¸ é–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«ã®ä½¿ç”¨ã¯ç¦æ­¢ã•ã‚Œã¦ã„ã¾ã™ã€‚');
			return false;
		}
	});

	// å³ã‚¯ãƒªãƒƒã‚¯ç„¡åŠ¹åŒ–
	document.addEventListener('contextmenu', e => {
		e.preventDefault();
		alert('âš ï¸ å³ã‚¯ãƒªãƒƒã‚¯ã¯ç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ã¾ã™ã€‚');
		return false;
	});

	// ã‚³ãƒ”ãƒ¼é˜²æ­¢
	document.addEventListener('copy', e => {
		e.preventDefault();
		return false;
	});
})();

// ========================================
// ãƒ¡ã‚¤ãƒ³æ©Ÿèƒ½
// ========================================

// ç®¡ç†è€…: ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½åŠ 
let typingTimer;
function adminAddUser() {
	const u = document.getElementById('admin-add-username').value.trim();
	const p = document.getElementById('admin-add-password').value;
	const msg = document.getElementById('admin-user-msg');
	
	if (!u || !p) { 
		msg.textContent = 'âš ï¸ ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›'; 
		return; 
	}
	
	// ãƒ¦ãƒ¼ã‚¶ãƒ¼åãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
	const usernamePattern = /^[a-zA-Z0-9_\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FFF]{3,20}$/;
	if (!usernamePattern.test(u)) {
		msg.textContent = 'âš ï¸ ãƒ¦ãƒ¼ã‚¶åã¯3ã€œ20æ–‡å­—ã®è‹±æ•°å­—ã€ã²ã‚‰ãŒãªã€ã‚«ã‚¿ã‚«ãƒŠã€æ¼¢å­—ã€ã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢ã®ã¿';
		return;
	}
	
	if (u === ADMIN_NAME) { 
		msg.textContent = 'âš ï¸ ç®¡ç†è€…åã¯è¿½åŠ ä¸å¯'; 
		return; 
	}
	
	let users = JSON.parse(localStorage.getItem('users')||'{}');
	if (users[u]) { 
		msg.textContent = 'âš ï¸ æ—¢ã«å­˜åœ¨ã—ã¾ã™'; 
		return; 
	}
	
	users[u] = { password: p };
	localStorage.setItem('users', JSON.stringify(users));
	msg.textContent = 'âœ“ è¿½åŠ ã—ã¾ã—ãŸ';
	msg.style.color = '#00ff00';
	document.getElementById('admin-add-username').value = '';
	document.getElementById('admin-add-password').value = '';
	loadAdminUserList();
	setTimeout(()=>{msg.textContent=''; msg.style.color='';},1200);
}

// ç®¡ç†è€…: ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤
function adminDeleteUser() {
	const select = document.getElementById('admin-user-list');
	const user = select.value;
	const msg = document.getElementById('admin-user-msg');
	if (!user) { msg.textContent = 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„'; return; }
	if (user === ADMIN_NAME) { msg.textContent = 'ç®¡ç†è€…ã¯å‰Šé™¤ã§ãã¾ã›ã‚“'; return; }
	let users = JSON.parse(localStorage.getItem('users')||'{}');
	if (!users[user]) { msg.textContent = 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå­˜åœ¨ã—ã¾ã›ã‚“'; return; }
	if (!confirm(user + ' ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
	delete users[user];
	localStorage.setItem('users', JSON.stringify(users));
	// é–¢é€£ãƒ‡ãƒ¼ã‚¿ã‚‚å‰Šé™¤
	let chats = JSON.parse(localStorage.getItem('chats')||'{}');
	delete chats[user];
	localStorage.setItem('chats', JSON.stringify(chats));
	let memos = JSON.parse(localStorage.getItem('userMemos')||'{}');
	delete memos[user];
	localStorage.setItem('userMemos', JSON.stringify(memos));
	msg.textContent = 'å‰Šé™¤ã—ã¾ã—ãŸ';
	loadAdminUserList();
	setTimeout(()=>{msg.textContent='';},1200);
}
// ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãƒ»ãƒãƒ£ãƒƒãƒˆå±¥æ­´ãƒ»ãƒ¡ãƒ¢ã¯localStorageã§ç°¡æ˜“ç®¡ç†
const ADMIN_NAME = "ã¨ã‚‚ã²ã“ã§ã™";
const ADMIN_PASS = "skytomo124";

function togglePw(id, el) {
	const input = document.getElementById(id);
	if (input.type === "password") {
		input.type = "text"; el.textContent = "éè¡¨ç¤º";
	} else {
		input.type = "password"; el.textContent = "è¡¨ç¤º";
	}
}

function showTyping() {
	document.getElementById('typing-indicator').style.display = 'block';
}

function hideTyping() {
	document.getElementById('typing-indicator').style.display = 'none';
}

function showRegister() {
	document.getElementById('register-area').classList.remove('hidden');
	document.getElementById('login-area').classList.add('hidden');
}
function showLogin() {
	document.getElementById('register-area').classList.add('hidden');
	document.getElementById('login-area').classList.remove('hidden');
}

function registerUser() {
	const u = document.getElementById('reg-username').value.trim();
	const p = document.getElementById('reg-password').value;
	
	// å…¥åŠ›ãƒã‚§ãƒƒã‚¯
	if (!u || !p) {
		document.getElementById('reg-msg').textContent = 'âš ï¸ ãƒ¦ãƒ¼ã‚¶åã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
		return;
	}
	
	// ãƒ¦ãƒ¼ã‚¶ãƒ¼åã®æ­£è¦è¡¨ç¾ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆç‰¹æ®Šæ–‡å­—ç¦æ­¢ï¼‰
	const usernamePattern = /^[a-zA-Z0-9_\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FFF]{3,20}$/;
	if (!usernamePattern.test(u)) {
		document.getElementById('reg-msg').textContent = 'âš ï¸ ãƒ¦ãƒ¼ã‚¶åã¯3ã€œ20æ–‡å­—ã®è‹±æ•°å­—ã€ã²ã‚‰ãŒãªã€ã‚«ã‚¿ã‚«ãƒŠã€æ¼¢å­—ã€ã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢ã®ã¿ä½¿ç”¨å¯èƒ½ã§ã™ã€‚\n@ãªã©ã®ç‰¹æ®Šè¨˜å·ã¯ä½¿ç”¨ã§ãã¾ã›ã‚“ã€‚';
		return;
	}
	
	// ç®¡ç†è€…åãƒã‚§ãƒƒã‚¯
	if (u === ADMIN_NAME || u.toLowerCase() === 'admin' || u.toLowerCase() === 'administrator') {
		document.getElementById('reg-msg').textContent = 'âš ï¸ ã“ã®ãƒ¦ãƒ¼ã‚¶åã¯ä½¿ç”¨ã§ãã¾ã›ã‚“ï¼ˆç®¡ç†è€…å°‚ç”¨ï¼‰';
		return;
	}
	
	// ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¼·åº¦ãƒã‚§ãƒƒã‚¯
	if (p.length < 6) {
		document.getElementById('reg-msg').textContent = 'âš ï¸ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯6æ–‡å­—ä»¥ä¸Šã«ã—ã¦ãã ã•ã„';
		return;
	}
	
	// æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒã‚§ãƒƒã‚¯
	let users = JSON.parse(localStorage.getItem('users')||'{}');
	if (users[u]) {
		document.getElementById('reg-msg').textContent = 'âš ï¸ æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶åã§ã™';
		return;
	}
	
	// ç™»éŒ²å®Ÿè¡Œ
	users[u] = { password: p };
	localStorage.setItem('users', JSON.stringify(users));
	document.getElementById('reg-msg').textContent = 'âœ“ ç™»éŒ²å®Œäº†ï¼ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„';
	document.getElementById('reg-msg').style.color = '#00ff00';
}

function loginUser() {
	const u = document.getElementById('login-username').value.trim();
	const p = document.getElementById('login-password').value;
	if (!u || !p) {
		document.getElementById('login-msg').textContent = 'ãƒ¦ãƒ¼ã‚¶åã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'; return;
	}
	if (u === ADMIN_NAME && p === ADMIN_PASS) {
		// ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³
		document.getElementById('login-msg').textContent = '';
		showAdmin();
		return;
	}
	let users = JSON.parse(localStorage.getItem('users')||'{}');
	if (!users[u] || users[u].password !== p) {
		document.getElementById('login-msg').textContent = 'ãƒ¦ãƒ¼ã‚¶åã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™'; return;
	}
	document.getElementById('login-msg').textContent = '';
	showChat(u);
}

function showChat(username) {
	localStorage.setItem('currentUser', username);
	document.getElementById('login-area').classList.add('hidden');
	document.getElementById('register-area').classList.add('hidden');
	document.getElementById('chat-area').classList.remove('hidden');
	loadChat();
	loadUserMemo();
	// ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ãƒãƒ£ãƒƒãƒˆã‚’å–å¾—
	fetch(`/api/chats/${encodeURIComponent(username)}`)
		.then(res => res.json())
		.then(data => {
			if (data.chats) {
				let localChats = JSON.parse(localStorage.getItem('chats')||'{}');
				localChats[username] = data.chats;
				localStorage.setItem('chats', JSON.stringify(localChats));
				loadChat();
			}
		})
		.catch(err => console.error('ã‚µãƒ¼ãƒåŒæœŸã‚¨ãƒ©ãƒ¼:', err));
}
// åˆ©ç”¨è€…ãƒ¡ãƒ¢ä¿å­˜ãƒ»èª­è¾¼
function saveUserMemo() {
	const user = localStorage.getItem('currentUser');
	const memo = document.getElementById('user-memo').value;
	let memos = JSON.parse(localStorage.getItem('userMemos')||'{}');
	memos[user] = memo;
	localStorage.setItem('userMemos', JSON.stringify(memos));
	document.getElementById('memo-msg').textContent = 'ä¿å­˜ã—ã¾ã—ãŸ';
	setTimeout(()=>{document.getElementById('memo-msg').textContent='';},1200);
}
function loadUserMemo() {
	const user = localStorage.getItem('currentUser');
	let memos = JSON.parse(localStorage.getItem('userMemos')||'{}');
	document.getElementById('user-memo').value = memos[user]||'';
}

function showAdmin() {
	document.getElementById('login-area').classList.add('hidden');
	document.getElementById('register-area').classList.add('hidden');
	document.getElementById('admin-area').classList.remove('hidden');
	loadAdminUserList();
}

function logout() {
	localStorage.removeItem('currentUser');
	localStorage.removeItem('autoLogin');
	localStorage.removeItem('savedUsername');
	localStorage.removeItem('savedPassword');
	document.getElementById('chat-area').classList.add('hidden');
	document.getElementById('admin-area').classList.add('hidden');
	showLogin();
}

function resetChat() {
	if (!confirm('ä¼šè©±å±¥æ­´ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) return;
	const user = localStorage.getItem('currentUser');
	let chats = JSON.parse(localStorage.getItem('chats')||'{}');
	delete chats[user];
	localStorage.setItem('chats', JSON.stringify(chats));
	loadChat();
}

function exportChat(format) {
	const user = localStorage.getItem('currentUser');
	let chats = JSON.parse(localStorage.getItem('chats')||'{}');
	const messages = chats[user] || [];
	if (messages.length === 0) {
		alert('ä¼šè©±å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“');
		return;
	}
	let content = '';
	if (format === 'txt') {
		content = messages.map(m => `${m.time} ${m.from}: ${m.text}`).join('\n');
	} else if (format === 'csv') {
		content = '\ufeffæ™‚é–“,é€ä¿¡è€…,ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸\n' + messages.map(m => `"${m.time}","${m.from}","${m.text.replace(/"/g, '""')}"`).join('\n');
	}
	const blob = new Blob([content], { type: format === 'txt' ? 'text/plain;charset=utf-8' : 'text/csv;charset=utf-8' });
	const url = URL.createObjectURL(blob);
	const a = document.createElement('a');
	a.href = url;
	a.download = `chat_history_${user}.${format}`;
	a.click();
function sendMessage() {
	const msg = document.getElementById('chat-input').value.trim();
	if (!msg) return;
	
	// ãƒãƒ£ãƒƒãƒˆé€ä¿¡æ™‚ã«ãƒã‚¤ãƒ³ãƒˆã‚’æ¶ˆè²»
	if (typeof pointsManager !== 'undefined') {
		pointsManager.onChatSend();
	}
	
	const user = localStorage.getItem('currentUser');
	let chats = JSON.parse(localStorage.getItem('chats')||'{}');
	if (!chats[user]) chats[user] = [];
	const id = generateId();
	chats[user].push({ id: id, from: user, text: msg, time: new Date().toLocaleString(), read: false });
	localStorage.setItem('chats', JSON.stringify(chats));
	document.getElementById('chat-input').value = '';
	document.getElementById('chat-input').style.height = 'auto'; // ãƒªã‚»ãƒƒãƒˆ
	document.getElementById('answer-options').innerHTML = '';
	loadChat();
	syncChats(user); // ã‚µãƒ¼ãƒãƒ¼åŒæœŸ
	autoReply(msg);
}loadChat();
	syncChats(user); // ã‚µãƒ¼ãƒãƒ¼åŒæœŸ
	autoReply(msg);
}

function sendSuggestion(msg) {
	document.getElementById('chat-input').value = msg;
	sendMessage();
}

function handleKeyDown(event) {
	if (event.key === 'Enter' && !event.shiftKey) {
		event.preventDefault();
		sendMessage();
	}
}

function autoResize(textarea) {
	textarea.style.height = 'auto';
	textarea.style.height = textarea.scrollHeight + 'px';
}

function loadChat() {
	const user = localStorage.getItem('currentUser');
	let chats = JSON.parse(localStorage.getItem('chats')||'{}');
	let html = '';
	(chats[user]||[]).forEach(m => {
		const displayName = m.from === ADMIN_NAME ? 'ç®¡ç†è€…' : m.from;
		// æ—¢èª­ã‚»ãƒƒãƒˆ
		if (!m.read) m.read = true;
		html += `<div class="msg ${m.from===user?'user':'admin'}"><b>${displayName}:</b> ${m.text} <span style='font-size:10px;color:#888;'>${m.time}</span>${m.read ? ' <span style="color:#0f0;">æ—¢èª­</span>' : ''}</div>`;
	});
	localStorage.setItem('chats', JSON.stringify(chats)); // æ—¢èª­æ›´æ–°
	document.getElementById('chat-box').innerHTML = html;
	document.getElementById('chat-box').scrollTop = 9999;
}

function updateSuggestions() {
	const userInput = document.getElementById('chat-input').value.trim().toLowerCase();
	const inappropriateKeywords = ["é¦¬é¹¿", "ãƒã‚«", "ã‚¢ãƒ›", "æ­»ã­", "æ®ºã™", "ã‚¯ã‚½", "ããŸã°ã‚Œ", "ä½¿ãˆãªã„", "å½¹ç«‹ãŸãš", "æœ€ä½", "ã‚´ãƒŸ", "ç³", "ç•œç”Ÿ", "ãƒ†ãƒ¡ã‚¨", "ãŠå‰", "ãƒ•ã‚¡ãƒƒã‚¯", "shit", "fuck", "damn", "bitch", "asshole", "bastard", "crap", "dumb", "idiot", "stupid"];
	fetch('/static/QA.json')
		.then(res => res.json())
		.then(data => {
			let candidates = [];
			if (!userInput) {
				// äºˆæ¸¬å€™è£œ: ãƒ©ãƒ³ãƒ€ãƒ ã§3-5ä»¶
				const filtered = data.filter(item => !item.keywords.some(k => inappropriateKeywords.some(ik => k.toLowerCase().includes(ik.toLowerCase()))));
				const shuffled = filtered.sort(() => 0.5 - Math.random());
				candidates = shuffled.slice(0, Math.floor(Math.random() * 3) + 3); // 3-5ä»¶
			} else {
				// å…¥åŠ›å€™è£œ: å…¥åŠ›ã«è¿‘ã„è¨€è‘‰ã€æœ€ä½5ä»¶ã€æœ€å¤§5ä»¶
				candidates = data.filter(item => {
					const hasInappropriate = item.keywords.some(k => inappropriateKeywords.some(ik => k.toLowerCase().includes(ik.toLowerCase())));
					if (hasInappropriate) return false;
					// éƒ¨åˆ†ä¸€è‡´: ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã«userInputã‚’å«ã‚€ã€ã¾ãŸã¯userInputã«ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å«ã‚€
					return item.keywords.some(k => k.toLowerCase().includes(userInput) || userInput.includes(k.toLowerCase()));
				});
				// é‡è¤‡é¿ã‘
				const seen = new Set();
				candidates = candidates.filter(item => {
					const keyword = item.keywords[0];
					if (seen.has(keyword)) return false;
					seen.add(keyword);
					return true;
				});
				// æœ€ä½5ä»¶: è¶³ã‚Šãªã„å ´åˆã€ãƒ©ãƒ³ãƒ€ãƒ è£œå……
				if (candidates.length < 5) {
					const remaining = data.filter(item => {
						const keyword = item.keywords[0];
						const hasInappropriate = item.keywords.some(k => inappropriateKeywords.some(ik => k.toLowerCase().includes(ik.toLowerCase())));
						return !hasInappropriate && !seen.has(keyword);
					});
					const shuffled = remaining.sort(() => 0.5 - Math.random());
					const additional = shuffled.slice(0, 5 - candidates.length);
					candidates.push(...additional);
				}
				// æœ€å¤§5ä»¶
				candidates = candidates.slice(0, 5);
			}
			const suggestions = candidates.map(item => item.keywords[0]);
			document.getElementById('suggestions').innerHTML = suggestions.map(s => `<button onclick="sendSuggestion('${s}')" style="background:#00f2fe; color:#fff; border:none; padding:6px 12px; border-radius:4px; cursor:pointer;">${s}</button>`).join('');
		})
		.catch(err => console.error('QA.json load error:', err));
}

function loadAdminUserList() {
	let users = JSON.parse(localStorage.getItem('users')||'{}');
	let select = document.getElementById('admin-user-list');
	select.innerHTML = '';
	Object.keys(users).forEach(u => {
		let opt = document.createElement('option');
		opt.value = u; opt.textContent = u;
		select.appendChild(opt);
	});
	// ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§è¡¨ç¤º
	let ul = document.getElementById('admin-user-list-view');
	ul.innerHTML = '';
	Object.keys(users).forEach(u => {
		let li = document.createElement('li');
		li.textContent = u;
		ul.appendChild(li);
	});
	showAdminChat();
	showAdminMemo();
}
// ç®¡ç†è€…ãŒé¸æŠãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¡ãƒ¢ã‚’è¡¨ç¤º
function showAdminMemo() {
	let user = document.getElementById('admin-user-list').value;
	let memos = JSON.parse(localStorage.getItem('userMemos')||'{}');
	document.getElementById('admin-user-memo').textContent = memos[user]||'';
}

function showAdminChat() {
	let user = document.getElementById('admin-user-list').value;
	let chats = JSON.parse(localStorage.getItem('chats')||'{}');
	let html = '';
	(chats[user]||[]).forEach(m => {
		const displayName = m.from === ADMIN_NAME ? 'ç®¡ç†è€…' : m.from;
		html += `<div class="msg ${m.from===ADMIN_NAME?'admin':'user'}"><b>${displayName}:</b> ${m.text} <span style='font-size:10px;color:#888;'>${m.time}</span></div>`;
	});
	document.getElementById('admin-chat-box').innerHTML = html;
	document.getElementById('admin-chat-box').scrollTop = 9999;
}

function sendAdminMessage() {
	let user = document.getElementById('admin-user-list').value;
	let msg = document.getElementById('admin-chat-input').value.trim();
	if (!msg) return;
	let chats = JSON.parse(localStorage.getItem('chats')||'{}');
	if (!chats[user]) chats[user] = [];
	chats[user].push({ from: ADMIN_NAME, text: msg, time: new Date().toLocaleString(), read: true });
	localStorage.setItem('chats', JSON.stringify(chats));
	document.getElementById('admin-chat-input').value = '';
	showAdminChat();
}

// åˆæœŸè¡¨ç¤º
function generateId() {
	return Date.now().toString() + Math.random().toString(36).substr(2, 9);
}

window.onload = function() {
	showLogin();
	// ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ãªã‚‰è‡ªå‹•å¾©å¸°
	const user = localStorage.getItem('currentUser');
	if (user) showChat(user);
};

function autoReply(userMsg) {
	const user = localStorage.getItem('currentUser');
	// åŸºæœ¬ã¯Gemini APIã‚’å‘¼ã¶
	fetch('/gemini', {
		method: 'POST',
		headers: { 'Content-Type': 'application/json' },
		body: JSON.stringify({ prompt: userMsg })
	})
	.then(res => res.json())
	.then(data => {
		if (data.answer) {
			let chats = JSON.parse(localStorage.getItem('chats')||'{}');
			if (!chats[user]) chats[user] = [];
			chats[user].push({ from: ADMIN_NAME, text: data.answer, time: new Date().toLocaleString(), read: true });
			localStorage.setItem('chats', JSON.stringify(chats));
			loadChat();
		} else {
			// GrokãŒä½¿ãˆãªã„å ´åˆã€QA.jsonã§å¯¾å¿œ
			fallbackToQA(userMsg, user);
		}
	})
	.catch(err => {
		console.error('Grok API error:', err);
		// GrokãŒä½¿ãˆãªã„å ´åˆã€QA.jsonã§å¯¾å¿œ
		fallbackToQA(userMsg, user);
	});
}

function fallbackToQA(userMsg, user) {
	fetch('/static/QA.json')
		.then(res => res.json())
		.then(data => {
			let found = false;
			for (let item of data) {
				if (item.keywords.some(k => userMsg.toLowerCase() === k.toLowerCase())) {
					found = true;
					// è¤‡æ•°ç­”ãˆãŒã‚ã‚‹å ´åˆã€é¸æŠãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
					if (item.answers && item.answers.length > 1) {
						document.getElementById('answer-options').innerHTML = item.answers.map(a => `<button onclick="selectAnswer('${a.replace(/'/g, "\\'")}')" style="background:#00f2fe; color:#fff; border:none; padding:6px 12px; border-radius:4px; cursor:pointer; margin:2px;">${a}</button>`).join('');
					} else {
						// 1ã¤ã ã‘ã®å ´åˆã€ç›´æ¥è¿½åŠ 
						let chats = JSON.parse(localStorage.getItem('chats')||'{}');
						if (!chats[user]) chats[user] = [];
						chats[user].push({ from: ADMIN_NAME, text: item.answers ? item.answers[0] : item.answer, time: new Date().toLocaleString(), read: true });
						localStorage.setItem('chats', JSON.stringify(chats));
						loadChat();
					}
					break;
				}
			}
			if (!found) {
				// QAã«ã‚‚ãƒãƒƒãƒã—ãªã‘ã‚Œã°ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
				let chats = JSON.parse(localStorage.getItem('chats')||'{}');
				if (!chats[user]) chats[user] = [];
				chats[user].push({ from: ADMIN_NAME, text: 'ã™ã„ã¾ã›ã‚“ã€ã‚ˆãã‚ã‹ã‚Šã¾ã›ã‚“', time: new Date().toLocaleString(), read: true });
				localStorage.setItem('chats', JSON.stringify(chats));
				loadChat();
			}
		})
		.catch(err => console.error('QA.json load error:', err));
}

function selectAnswer(answer) {
	const user = localStorage.getItem('currentUser');
	let chats = JSON.parse(localStorage.getItem('chats')||'{}');
	if (!chats[user]) chats[user] = [];
	chats[user].push({ from: ADMIN_NAME, text: answer, time: new Date().toLocaleString(), read: true });
	localStorage.setItem('chats', JSON.stringify(chats));
	document.getElementById('answer-options').innerHTML = '';
	loadChat();
}

function syncChats(user) {
	let chats = JSON.parse(localStorage.getItem('chats')||'{}');
	let userChats = chats[user] || [];
	// ã‚µãƒ¼ãƒãƒ¼ã«ä¿å­˜
	fetch(`/api/chats/${encodeURIComponent(user)}`, {
		method: 'POST',
		headers: { 'Content-Type': 'application/json' },
		body: JSON.stringify({ chats: userChats })
	})
	.then(res => res.json())
	.then(data => {
		// ä¿å­˜æˆåŠŸ
	})
	.catch(err => console.error('ã‚µãƒ¼ãƒåŒæœŸã‚¨ãƒ©ãƒ¼:', err));
}

// Service Workerç™»éŒ²
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/sw.js')
        .then(registration => {
            console.log('Service Worker registered with scope:', registration.scope);
        })
        .catch(error => {
            console.log('Service Worker registration failed:', error);
        });
}

// ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼æ©Ÿèƒ½
document.addEventListener('DOMContentLoaded', () => {
    const hamburgerButton = document.getElementById('hamburger-menu-btn');
    const toc = document.getElementById('table-of-contents');

    if (hamburgerButton && toc) {
        hamburgerButton.addEventListener('click', e => {
            e.stopPropagation();
            toc.classList.toggle('open');
        });
        document.body.addEventListener('click', e => {
            if (toc.classList.contains('open') && !toc.contains(e.target) && e.target !== hamburgerButton) {
                toc.classList.remove('open');
            }
        });
    }
});
</script>
<script src="static/security.js"></script>
</body>
</html>